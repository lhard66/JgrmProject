<!DOCTYPE html>
<html lang="zh-Hans">

<head>
  <meta charset="utf-8">
  <title>保养信息修改</title>
  <link href="/car-business/static/plugins/hp/css/bootstrap.min.css?v=3.3.5" rel="stylesheet">
</head>
<style>
.main-content {
  width: 800px;
  margin: 10px 20px;
}

.btn-add {
  display: inline-block;
  width: 100%;
  height: 100%;
  cursor: pointer;
}


/*选择车型部分开始*/

.has-feedback .form-control {
  cursor: pointer;
}

.car-series {
  display: none;
  margin: 20px;
}

.car-series .cartype-content>label {
  font-weight: normal;
  margin-right: 30px;
  cursor: pointer;
}

.btn {
  margin-top: 6px;
  width: 100px;
}


/*选择车型部分结束*/

.car-oil .form-group {
  margin: 15px 0 0 0;
}
</style>

<body>
  <div id="app" class="content">
    <div class="main-content" v-if="workData!=null">
      <form>
        <div class="form-group">
          <label>套餐编号：</label>
          <input type="text" class="form-control" readonly>
        </div>
        <div class="form-group">
          <label for="exampleInputEmail1">套餐类型：</label>
          <select class="form-control">
            <option v-for="item in maintainType" :value="item.id">{{item.name}}</option>
          </select>
        </div>
        <div class="form-group has-feedback">
          <label class="control-label">适用车系：</label>
          <input type="text" class="form-control" @click="showCarSeries" readonly>
          <span class="glyphicon glyphicon-th-list form-control-feedback" aria-hidden="true"></span>
          <input type="hidden" name="carBrandId" :value="seriesItemAllData.brandId">
          <input type="hidden" name="carSeriesId" :value="seriesItemAllData.seriesId">
        </div>
        <div class="form-group">
          <label for="exampleInputPassword1">推荐机油：</label>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>机油品牌</th>
                <th>机油型号</th>
                <th>配图</th>
                <th>包装规格</th>
                <th>价格</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="item in workData.rows">
                <td>{{item.brand}}</td>
                <td>{{item.type}}</td>
                <td>图片</td>
                <td>{{item.size}}</td>
                <td>{{item.price}}</td>
                <td>
                  <a href="javascript:void(0);" @click="editRow(item.id)">编辑</a> | <a href="javascript:void(0);" @click="delRow(item.id)">删除</a>
                </td>
              </tr>
              <tr>
                <td colspan="6">
                  <a class="btn-add" href="#" @click="addItem">+ 添加项...</a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <button type="submit" class="btn btn-default">提交</button>
      </form>
    </div>
    <!-- 适合用车系 -->
    <div class="car-series" id="car_series">
      <form>
        <div>
          <label>品牌：</label>
          <div class="cartype-content">
            <label v-for="item in seriesBrandData">
              <input type="radio" name="brand" @change="selBrand(item.carBrandId)" :value="item.carBrandId">
              <span>{{item.carBrandName}}</span>
            </label>
          </div>
        </div>
        <div v-if="seriesOthersTypeName!=null">
          <label>类别：</label>
          <div class="cartype-content">
            <label v-for="item in seriesOthersTypeName">
              <input type="radio" name="type" :value="item" @change="selType(item)">
              <span>{{item}}</span>
            </label>
          </div>
        </div>
        <div v-if="seriesOthersGroupInObjCar!=null">
          <label>车系：</label>
          <div class="cartype-content">
            <label v-for="item in seriesOthersGroupInObjCar">
              <input type="radio" name="seriesCar" :value="item" v-model="seriesItemAllData">
              <span>{{item.series}}</span>
            </label>
          </div>
        </div>
        <div class="btn">
          <a href="javascript:void(0);" class="btn btn-default" @click="saveSeries">保存</a>
          <a href="javascript:void(0);" class="btn btn-default" @click="cancelSeries">取消</a>
        </div>
      </form>
    </div>
    <!-- 添加机油类型部分 -->
    <div id="car_oil" class="car-oil">
      <form class="form-horizontal" v-if="oilData.brand!=undefined">
        <div class="form-group">
          <label class="col-sm-3 control-label">机油品牌:</label>
          <div class="col-sm-9">
            <select class="form-control" @change="selOilBrand">
              <option selected :value="-1">请选择机油品牌</option>
              <option v-for="item in oilData.brand" :value="item.id">{{item.title}}</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label">机油型号:</label>
          <div class="col-sm-9">
            <select class="form-control">
              <option selected :value="-1">请选择机油型号</option>
              <option v-for="item in oilData.type" :value="item.id">{{item.title}}</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <div class="col-sm-offset-3 col-sm-9">
            <span>找不到需要的型号？</span><a href="javascript:void(0);" @click="faceback">点这里留言反馈</a>
          </div>
        </div>
        <div class="form-group">
          <div class="col-sm-offset-3 col-sm-9">
            <a href="javascript:void(0);" @click="addConfirm" class="btn btn-default" v-if="oilStatus==2">添加</a>
            <a href="javascript:void(0);" @click="editConfirm" class="btn btn-default" v-if="oilStatus==1">修改</a>
            <a href="javascript:void(0);" @click="addCancel" class="btn btn-default">取消</a>
          </div>
        </div>
      </form>
    </div>
  </div>
  <script src="/car-business/static/plugins/vue/vue.js"></script>
  <script src="/car-business/static/plugins/hp/js/jquery.min.js?v=2.1.4"></script>
  <script src="./js/lodash.min.js"></script>
  <script src="/car-business/static/plugins/hp/js/plugins/layer/layer.js"></script>
  <script>
  var oilStatus = {
    edit: 1,
    add: 2
  }
  var vm = new Vue({
    el: '#app',
    data: {
      maintainType: null,
      workData: {}, //页面列表数据
      workRow: {
        brand: -1,
        type: -1,
      }, //页面某行数据
      oilData: {
        brand: null,
        type: null,
      }, //弹窗基础数据
      indexWindow: -1, //弹窗id
      oilStatus: 0, //弹窗是添加按钮还是修改按钮
      seriesBrandData: null, //适用车型品牌数据，原始
      seriesOthersData: null, //适用车型其它数据，原始
      seriesOthersGroupData: null, //适用车型分组后
      seriesOthersTypeName: null, //适用车型类型数据，第二组的名字，仅类型名
      seriesOthersGroupInObjCar: null, //第三组中的名字
      seriesItemAllData: {
        brandId: -1,
        seriesId: -1,
      }, //选中具体车系的所有数据
      test: null,
    },
    mounted: function() {
      var _this = this;
      //获取保养类型列表
      $.getJSON('/car-business/car/maintance/scheme/category/list', function(res) {
        console.log(res);
        _this.maintainType = res.data;
      });
      //拿到列表数据
      fetch('./data/workData.json').then(function(res) {
        return res.json();
      }).then(function(dataJson) {
        _this.workData = dataJson.data;
      }).catch(function(err) {
        alert(err);
      });
      //加载推荐机油弹出框，机油品牌数据      
      $.getJSON('/car-business/car/maintance/parts/brand/list', function(res) {
        _this.oilData.brand = res.data;
      });
    },
    methods: {
      showOilLayer: function() {
        var _workRow = {};
        var _oilDataRow = this.oilData;
        _workRow.id = Date.now() + Math.round(Math.random() * 10000);
        _workRow.price = _oilDataRow.price;
        _workRow.brand = _oilDataRow.brand[0].name;
        _workRow.type = _oilDataRow.type[0].name;
        _workRow.size = _oilDataRow.size[0].name;
        this.workRow = _workRow;
      },
      addItem: function() {
        // this.showOilLayer();
        this.oilStatus = oilStatus.add;
        this.indexWindow = layer.open({
          type: 1,
          title: '添加推荐机油',
          area: ['500px', '400px'], //宽高
          content: $('#car_oil')
        });
      },
      addConfirm: function() {
        //对象拷贝    
        var workRowTemp = JSON.stringify(this.workRow);
        var newWorkRow = JSON.parse(workRowTemp);
        this.workData.rows.push(newWorkRow);
        layer.close(this.indexWindow);
      },
      addCancel: function() {
        layer.close(this.indexWindow);
      },
      faceback: function() {
        layer.open({
          type: 2,
          title: '反馈留言',
          area: ['470px', '320px'], //宽高
          content: './faceback.html'
        });
      },
      delRow: function(num) {
        console.log(num);
        var newWorkData = [];
        console.log(this.workData.rows);
        this.workData.rows.forEach(function(item) {
          if (item.id != num) {
            newWorkData.push(item);
          }
        });
        console.log(newWorkData);
        this.workData.rows = newWorkData;
      },
      editRow: function(num) {
        this.oilStatus = oilStatus.edit;
        this.workData.rows.forEach(function(item) {
          if (item.id == num) {
            var workRowTemp = JSON.stringify(item);
            console.log(workRowTemp);
            var newWorkRow = JSON.parse(workRowTemp);
            this.workRow = newWorkRow;
            return;
          }
        }, this);
        this.indexWindow = layer.open({
          type: 1,
          title: '修改推荐机油',
          area: ['500px', '400px'],
          content: $('#car_oil')
        });
      },
      editConfirm: function() {
        var _this = this;
        var workRowTemp = JSON.stringify(this.workRow);
        var newWorkRow = JSON.parse(workRowTemp);
        for (var i = 0; i < _this.workData.rows.length; i++) {
          if (_this.workData.rows[i].id == newWorkRow.id) {
            _this.$set(_this.workData.rows, i, newWorkRow);
          }
        }
        layer.close(this.indexWindow);
      },
      //选择车型部分
      showCarSeries: function() {
        var _this = this;
        $.getJSON('/car-business/car/maintance/own/brand/list', function(res) {
          _this.seriesBrandData = res.data;
        }).error(function(res) {
          layer.msg('汽车品牌列表获取失败！', {
            icon: 2
          });
        });
        this.indexWindow = layer.open({
          type: 1,
          title: '适用车系设置',
          area: ['730px', '450px'],
          content: $('#car_series')
        });
      },
      selBrand: function(carBrandId) {
        //将第二级和第三级设置为null
        this.seriesOthersTypeName = null;
        this.seriesOthersGroupInObjCar = null;
        var _this = this;
        $.getJSON('/car-business/car/car/series/list?brandId=' + carBrandId, function(res) {
          _this.seriesOthersData = res.data;
          _this.seriesOthersGroupData =
            _.groupBy(_this.seriesOthersData, function(item) {
              return item.manufacturer;
            });
          _this.seriesOthersTypeName = Object.keys(_this.seriesOthersGroupData);
        }).error(function() {
          layer.msg('车系列表获取失败！', {
            icon: 2
          });
        })
      },
      selType: function(name) {
        //将第三级设置为空
        this.seriesOthersGroupInObjCar = null;
        var _this = this;
        for (var itemKey in this.seriesOthersGroupData) {
          if (itemKey == name) {
            _this.seriesOthersGroupInObjCar = this.seriesOthersGroupData[itemKey];
            return;
          }
        }
      },
      saveSeries: function() {
        if (this.seriesItemAllData.seriesId != -1 && this.seriesItemAllData.brandId) {
          //隐藏对话框
          layer.close(this.indexWindow);
        } else {
          layer.msg('请选择保养车型！', {
            icon: 2
          });
        }
      },
      cancelSeries: function() {
        layer.close(this.indexWindow);
      },
      //选择车型部分结束
      selOilBrand: function(id) {
        var _this = this;
        $.getJSON('/car-business/car/maintance/parts/model/list?brandId=1', function(res) {
          _this.oilData.type = res.data;
        })
      }
    }
  })
  </script>
</body>

</html>
